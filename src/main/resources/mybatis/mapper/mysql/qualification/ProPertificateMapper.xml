<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.cmcc.qualification.dao.ProPertificateDao">
  <!-- 新增资质信息 addProPertificate -->
  <insert id="addProPertificate" parameterType="com.cmcc.qualification.entity.ProPertificate">
    insert into pro_certificate 
    <trim prefix="(" suffix=")" suffixOverrides="," >
      <if test="certificateId != null" >
        certificate_id,
      </if>
      <if test="fkcertId != null" >
        fkcert_id,
      </if>
      <if test="certificateType != null" >
        certificate_type,
      </if>
      <if test="certificateName != null" >
        certificate_name,
      </if>
      <if test="certificateCode != null" >  
        certificate_code,
      </if>
      <if test="jobCategory != null" >  
        job_category,
      </if>
      <if test="permitProject != null" >  
        permit_project,
      </if>
      <if test="firstDate != null" >  
        first_date,
      </if>
      <if test="effectiveDate != null" >  
        effective_date,
      </if>
      <if test="fileUrl != null" >  
        file_url,
      </if>
      <if test="createUser != null" >  
        create_user,
      </if>
      <if test="remark != null" >
        remark,
      </if>
      create_time
    </trim>
    <trim prefix="values (" suffix=")" suffixOverrides="," >
      <if test="certificateId != null" >
        #{certificateId},
      </if>
      <if test="fkcertId != null" >
        #{fkcertId},
      </if>
      <if test="certificateType != null" >
        #{certificateType},
      </if>
      <if test="certificateName != null" >
        #{certificateName},
      </if>
      <if test="certificateCode != null" >
        #{certificateCode},
      </if>
      <if test="jobCategory != null" >
        #{jobCategory},
      </if>
      <if test="permitProject != null" >
        #{permitProject},
      </if>
      <if test="firstDate != null" >
        #{firstDate},
      </if>
      <if test="effectiveDate != null" >
        #{effectiveDate},
      </if>
      <if test="fileUrl != null" >
        #{fileUrl},
      </if>
      <if test="createUser != null" >
        #{createUser},
      </if>
      <if test="remark != null" >
        #{remark},
      </if>
      now()
    </trim>
  </insert>
  
  <!-- 根据用户id查询该用户所有资质信息 selectAllProPertificateByUserId -->
  <select id="selectAllProPertificateByUserId" parameterType="java.lang.String" resultType="com.cmcc.qualification.entity.ProPertificate">
    select 
      certificate_id as certificateId,
      fkcert_id as fkcertId,
      certificate_type as certificateType,
      certificate_name as certificateName,
      certificate_code as certificateCode,
      job_category as jobCategory,
      permit_project as permitProject,
      first_date as firstDate,
      effective_date as effectiveDate,
      file_url as fileUrl,
      create_user as createUser,
      create_time as createTime,
      remark as remark
    from 
      pro_certificate
    where  
      fkcert_id = #{userId} 
  </select>
  
  <!-- 根据个人资质信息id查询资质详情 getPersonalQualificationInfo -->  
  <select id="getPersonalQualificationInfo" parameterType="java.lang.String" resultType="com.cmcc.qualification.entity.ProPertificate">
	select a.certificateId,a.fkcertId,a.certificateName,a.certificateCode,
	a.jobCategory,a.permitProject,a.effectiveDate,a.remark,
	GROUP_CONCAT(fileId) fileId,GROUP_CONCAT(fileUrl) fileUrl from (
select 
			p.certificate_id certificateId,
			p.fkcert_id fkcertId,
      p.certificate_name as certificateName,
      p.certificate_code as certificateCode,
      p.job_category as jobCategory,
      p.permit_project as permitProject,
      date_format(p.effective_date, '%Y-%m-%d') as effectiveDate,
      p.remark,
      f.file_id as fileId, 
      f.file_url as fileUrl 
    from pro_certificate p 
         left join file_store f on p.certificate_id=f.to_id 
    where p.certificate_id = #{certificateId}
) a GROUP BY a.certificateId,a.fkcertId,a.certificateName,a.certificateCode,
	a.jobCategory,a.permitProject,a.effectiveDate,a.remark
	
  </select>
  
  <!-- delPersonalQuaInfo 根据个人资质id删除对应资质信息 -->
  <delete id="delPersonalQuaInfo" parameterType="java.lang.String">
    delete from pro_certificate
    where certificate_id = #{certificateId,jdbcType=VARCHAR}
  </delete>
  <!-- 根据公司资质删除工资资质信息 -->
  <delete id="deleteByFkcertId" parameterType="java.lang.String">
    delete from pro_certificate
    where fkcert_id = #{comqId,jdbcType=VARCHAR}
  </delete>
  
  <update id="updateByPrimarySelective" parameterType="com.cmcc.qualification.entity.ProPertificate">
    update pro_certificate
    <set>
      <if test="fkcertId != null" >
        fkcert_id = #{fkcertId}, 
      </if>
      <if test="certificateType != null" >
        certificate_type = #{certificateType},
      </if>
      <if test="certificateName != null" >
        certificate_name = #{certificateName},
      </if>
      <if test="certificateCode != null" >  
        certificate_code = #{certificateCode},
      </if>
      <if test="jobCategory != null" >  
        job_category = #{jobCategory},
      </if>
      <if test="permitProject != null" >  
        permit_project = #{permitProject},
      </if>
      <if test="firstDate != null" >  
        first_date = #{firstDate},
      </if>
      <if test="effectiveDate != null" >  
        effective_date = #{effectiveDate},
      </if>
      <if test="fileUrl != null" >  
        file_url = #{fileUrl},
      </if>
      <if test="createUser != null" >  
        create_user = #{createUser},
      </if>
      <if test="remark != null" >
        remark = #{remark},
      </if>
    </set>
    where certificate_id = #{certificateId}
  </update>
</mapper>